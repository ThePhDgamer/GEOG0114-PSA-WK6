<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Raster Analysis &amp; Geostatistics using Kriging</title>

<script src="site_libs/header-attrs-2.9/header-attrs.js"></script>
<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>








<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">GEOG0114 Principles of Spatial Analysis</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">1. Getting Started</a>
</li>
<li>
  <a href="variogram.html">2. Variogram Analysis</a>
</li>
<li>
  <a href="kriging.html">3. Kriging</a>
</li>
<li>
  <a href="recommendation.html">4. Recommended Reading</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Raster Analysis &amp; Geostatistics using Kriging</h1>
<h4 class="date">Week 6: 14/11/2021</h4>

</div>


<style type: "text/css">
h1.title {
    font-size: 20px;
}

h4.date {
    font-size: 18px;
}

h1 {
    font-size: 18px;
}

h2 {
    font-size: 18px;
}

body{/* Normal */
    font-size: 13px;
    text-align: justify;
}

p.comment {
background-color: #DBDBDB;
padding: 10px;
border: 1px solid black;
border-radius: 5px;
}

code.r{
  font-size: 10px;
}
pre {
  font-size: 12px
}
</style>
<hr style="border:2px solid gray">
</hr>
<div id="building-the-raster-template" class="section level2">
<h2><strong>3.1. Building the Raster Template</strong></h2>
<p>Let us create a template raster for interpolation. The extent of the raster template should based on the points. We are going to make the resolution of grid be at 5000m by 5000m (5km by 5km) accordingly.</p>
<pre class="r"><code>RasterTemplate &lt;- raster(datafile_sp_prj)
res(RasterTemplate) &lt;- 5000</code></pre>
<p>Next, declare template as a spatial grid</p>
<pre class="r"><code>grid.interpolation &lt;- as(RasterTemplate, &#39;SpatialGrid&#39;)</code></pre>
</div>
<div id="spatial-interpolation-using-kriging" class="section level2">
<h2><strong>3.2. Spatial Interpolation using Kriging</strong></h2>
<p>Now, we are going to use the parameters from the exponential theoretical semivariogram model to interpolate the concentrations of ambient SO2 for the entire study region</p>
<pre class="r"><code>modelKrigingExp &lt;- gstat(formula = Mean_SO2~1, locations = datafile_sp_prj, model = exp_SO2_emp.variogram)</code></pre>
<p>The results are stored in <code>modelKrigingExp</code> object. Lets add the results of the interpolation to our grid template using the <code>predict()</code> function</p>
<pre class="r"><code># this may take roughly 5mins
Kriged_SO2 &lt;- predict(modelKrigingExp, grid.interpolation)</code></pre>
<p>The above analysis produces two separate rasters: i.) Predicted <span class="math inline">\(SO_{2}\)</span> and ii.) Variation in <span class="math inline">\(SO_{2}\)</span>. Let export the results and make some visualisation using the <code>tmap</code> functions</p>
</div>
<div id="export-the-results-as-.tiff-format-and-thematic-visualisation-in-tmap" class="section level2">
<h2><strong>3.3. Export the results as .tiff format and Thematic visualisation in</strong> <code>tmap</code></h2>
<p>Save both the prediction and variance a multi-layer raster (a ‘brick’ raster):</p>
<pre class="r"><code>brickedKriged_SO2_Results &lt;- brick(Kriged_SO2)</code></pre>
<p>We can save them individually from the multi-layer raster as follows:</p>
<pre class="r"><code># Separate the rasters accordingly
exp.prediction &lt;- raster(brickedKriged_SO2_Results, layer = 1)
exp.variance &lt;- raster(brickedKriged_SO2_Results, layer = 2)
#  save the output locally on your computer
writeRaster(exp.prediction, &quot;Predicted SO2 levels in USA.tif&quot;, format=&quot;GTiff&quot;, overwrite = TRUE)
writeRaster(exp.variance, &quot;Variance SO2 levels in USA.tif&quot;, format=&quot;GTiff&quot;, overwrite = TRUE)</code></pre>
<p>Let us visualise the predictions:</p>
<pre class="r"><code># mask values of raster outside regions of US Border
exp.prediction_masked &lt;- mask(exp.prediction, US_Nation_Border_sp_shp)

tm_shape(US_Nation_Border_shp) + tm_polygons(alpha = 0, border.col = &quot;black&quot;) + # add base map of borders here
    tm_shape(exp.prediction_masked) + tm_raster(title = &quot;Predicted SO2 ppb&quot;, style = &quot;cont&quot;, palette = &quot;Reds&quot;) +
    tm_shape(US_State_Borders_shp) + tm_polygons(alpha = 0, border.col = &quot;black&quot;) +
    tm_text(&quot;STUSPS&quot;, size = &quot;AREA&quot;) +
    tm_shape(datafile_sf_prj) + tm_dots() + 
    tm_scale_bar(position = c(&quot;left&quot;,&quot;bottom&quot;)) +
    tm_compass(position = c(&quot;right&quot;, &quot;bottom&quot;)) +
    tm_layout(frame = FALSE, legend.title.size = 0.5, legend.text.size = 0.5)</code></pre>
<center>
<img src="Image3_1.png" title="fig:" alt="“/Users/anwarmusah/Documents/GITHUB/GEOG0114-PSA-WK6/GEOG0114-PSA-WK6”" />
</center>
<p>The above shows the predicted concentrations of ambient <span class="math inline">\(SO_{2}\)</span>; however, the predicted surface is very smooth and it difficult to see the spatial patterns. One technique, which is sometimes useful, for raster data is to reclassify the pixels to zones instead of pixel-point estimates.</p>
<p>We could reclassify the continuous values stored in the grids/pixels into discrete values using the following scheme: - 0 = <code>"&lt; 1.0 ppb"</code> - 1 = <code>"1.0-4.9 ppb"</code> - 2 = <code>"5.0-9.9 ppb"</code> - 3 = <code>"10.0-14.9 ppb"</code> - 4 = <code>"15.0-19.9 ppb"</code> - 5 = <code>"20.0-29.9 ppb"</code> - 6 = <code>"30.0-39.9 ppb"</code> - 7 = <code>"+40.0 ppb"</code></p>
<p>You can do this by using following code:</p>
<pre class="r"><code># Create a vector for the reclassification -i.e., 1st row captures values between 0 and below 1 to reclassify a pixel as 0
# the 2nd row in this vector captures values between 1 and below 5 to reclassify a pixel as 1 and so on and so forth
reclassifyRaster &lt;- c(0,1,0,
1,5,1,
5,10,2,
10,15,3,
15,20,4,
20,30,5,
30,40,6,
40,70,7)

# Then store the values into a matrix 
reclassifyRaster_Mat &lt;- matrix(reclassifyRaster, ncol=3, byrow=TRUE)
reclassifyRaster_Mat</code></pre>
<pre><code>##      [,1] [,2] [,3]
## [1,]    0    1    0
## [2,]    1    5    1
## [3,]    5   10    2
## [4,]   10   15    3
## [5,]   15   20    4
## [6,]   20   30    5
## [7,]   30   40    6
## [8,]   40   70    7</code></pre>
<p>Now, apply the matrix to the raster object to reclassify the pixels accordingly using the <code>reclassify()</code> function:</p>
<pre class="r"><code>exp.prediction_masked_rec &lt;- reclassify(exp.prediction_masked, reclassifyRaster_Mat)</code></pre>
<p>Now, lets visualise the zones:</p>
<pre class="r"><code>tm_shape(US_Nation_Border_shp) + tm_polygons(alpha = 0, border.col = &quot;black&quot;) + # add base map of borders here
    tm_shape(exp.prediction_masked_rec) + tm_raster(title = &quot;Predicted SO2 ppb&quot;, style = &quot;cat&quot;, palette = &quot;Reds&quot;, 
                     labels = c(&quot;&lt;1.0 ppbs&quot;,&quot;1.0-4.9 ppb&quot;,&quot;5.0-9.9 ppb&quot;, &quot;10.0-14.9 ppb&quot; , &quot;15.0-19.9 ppb&quot;, &quot;20.0-29.9 ppb&quot;, &quot;30.0-39.9 ppb&quot;,&quot;+40.0ppb&quot;)) +
    tm_shape(US_State_Borders_shp) + tm_polygons(alpha = 0, border.col = &quot;black&quot;) +
    tm_text(&quot;STUSPS&quot;, size = &quot;AREA&quot;) +
    tm_shape(datafile_sf_prj) + tm_dots() + 
    tm_scale_bar(position = c(&quot;left&quot;,&quot;bottom&quot;)) +
    tm_compass(position = c(&quot;right&quot;, &quot;bottom&quot;)) +
    tm_layout(frame = FALSE, legend.title.size = 0.5, legend.text.size = 0.5)</code></pre>
<center>
<img src="Image3_2_5.png" title="fig:" alt="“/Users/anwarmusah/Documents/GITHUB/GEOG0114-PSA-WK6/GEOG0114-PSA-WK6”" />
</center>
<p>You can visualise the variance:</p>
<pre class="r"><code># mask values of raster outside regions of US Border
exp.variance_masked &lt;- mask(exp.variance, US_Nation_Border_sp_shp)

tm_shape(US_Nation_Border_shp) + tm_polygons(alpha = 0, border.col = &quot;black&quot;) + # add base map of borders here
    tm_shape(exp.variance_masked) + tm_raster(title = &quot;Variance SO2 ppb&quot;, style = &quot;cont&quot;, palette = &quot;Reds&quot;) +
    tm_shape(US_State_Borders_shp) + tm_polygons(alpha = 0, border.col = &quot;black&quot;) +
    tm_text(&quot;STUSPS&quot;, size = &quot;AREA&quot;) +
    tm_shape(datafile_sf_prj) + tm_dots() + 
    tm_scale_bar(position = c(&quot;left&quot;,&quot;bottom&quot;)) +
    tm_compass(position = c(&quot;right&quot;, &quot;bottom&quot;)) +
    tm_layout(frame = FALSE, legend.title.size = 0.5, legend.text.size = 0.5)</code></pre>
<center>
<img src="Image3_2.png" title="fig:" alt="“/Users/anwarmusah/Documents/GITHUB/GEOG0114-PSA-WK6/GEOG0114-PSA-WK6”" />
</center>
<p class="comment">
<strong>IMPORTANT NOTES</strong>: The above example was a null model. We can include risk factors as adjustments for the prediction. The below code shows you how to incorporate other variables in the analysis. We will use the <code>CarIndex</code> column. In most cases the results are similar.
</p>
<pre class="r"><code># use variogram() function to compute the semivariance 
SO2_adj_emp.variogram &lt;- variogram(Mean_SO2~CarIndex, datafile_sp_prj)
# Compute the object to reveal a table
SO2_adj_emp.variogram
# Plot the empirical semivariogram and extract initial values
plot(SO2_adj_emp.variogram)

# Determine best model
best_SO2_adj_emp.variogram &lt;- fit.variogram(SO2_adj_emp.variogram, model = vgm(c(&quot;Exp&quot;, &quot;Gau&quot;, &quot;Sph&quot;)))
best_SO2_adj_emp.variogram # exponential is the best again. 
plot(SO2_adj_emp.variogram, best_SO2_adj_emp.variogram, main = &quot;Best Model: Exponential (Nug: 3.6, PSill: 55.9, Range: 295077m)&quot;)

# reusing raster templates for predictions
modelKrigingExp_adj &lt;- gstat(formula = Mean_SO2~CarIndex, locations = datafile_sp_prj, model = best_SO2_adj_emp.variogram)
Kriged_SO2_adj &lt;- predict(modelKrigingExp_adj, grid.interpolation)
brickedKriged_SO2_Results_adj &lt;- brick(Kriged_SO2_adj)

exp.prediction_adj &lt;- raster(brickedKriged_SO2_Results_adj, layer = 1)
exp.variance_adj &lt;- raster(brickedKriged_SO2_Results_adj, layer = 2)

writeRaster(exp.prediction_adj, &quot;Adjusted Predicted SO2 levels in USA.tif&quot;, format=&quot;GTiff&quot;, overwrite = TRUE)
writeRaster(exp.variance_adj, &quot;Adjusted Variance SO2 levels in USA.tif&quot;, format=&quot;GTiff&quot;, overwrite = TRUE)

# use tmap functions like before</code></pre>
<hr style="border:2px solid gray">
</hr>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
